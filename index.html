<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BLE Data Visualization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        canvas {
            width: 100%;
            height: 300px;
            background: #f3f3f3;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>BLE Data Visualization</h1>
    <button id="connectBtn">Connect to ESP32</button>
    <canvas id="chartCanvas"></canvas>
    <script>
        const DEVICE_NAME = "NPG";
        const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const DATA_CHAR_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
        const SINGLE_SAMPLE_LEN = 7;
        const ctx = document.getElementById("chartCanvas").getContext("2d");
        const chartData = { ch0: [], ch1: [], ch2: [] };

        function updateChart() {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.beginPath();
            ctx.strokeStyle = "red";
            chartData.ch0.forEach((y, i) => {
                ctx.lineTo(i * 3, 150 - y / 50);
            });
            ctx.stroke();
            ctx.beginPath();
            ctx.strokeStyle = "blue";
            chartData.ch1.forEach((y, i) => {
                ctx.lineTo(i * 3, 150 - y / 50);
            });
            ctx.stroke();
            ctx.beginPath();
            ctx.strokeStyle = "green";
            chartData.ch2.forEach((y, i) => {
                ctx.lineTo(i * 3, 150 - y / 50);
            });
            ctx.stroke();
        }

        function processSample(dataView) {
            if (dataView.byteLength !== SINGLE_SAMPLE_LEN) return;
            const ch0 = dataView.getInt16(1, false);
            const ch1 = dataView.getInt16(3, false);
            const ch2 = dataView.getInt16(5, false);
            console.log(`Channels: ${ch0}, ${ch1}, ${ch2}`);
            chartData.ch0.push(ch0);
            chartData.ch1.push(ch1);
            chartData.ch2.push(ch2);
            if (chartData.ch0.length > 100) {
                chartData.ch0.shift();
                chartData.ch1.shift();
                chartData.ch2.shift();
            }
            updateChart();
        }

        function handleNotification(event) {
            const value = event.target.value;
            if (value.byteLength === SINGLE_SAMPLE_LEN) {
                processSample(new DataView(value.buffer));
            }
        }

        async function connectBLE() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: DEVICE_NAME }],
                    optionalServices: [SERVICE_UUID],
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                const dataChar = await service.getCharacteristic(DATA_CHAR_UUID);
                await dataChar.startNotifications();
                dataChar.addEventListener("characteristicvaluechanged", handleNotification);
                console.log("Connected and receiving data...");
            } catch (error) {
                console.log("Error: " + error);
            }
        }

        document.getElementById("connectBtn").addEventListener("click", connectBLE);
    </script>
</body>
</html>