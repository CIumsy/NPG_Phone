<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BLE Web Connection</title>
  </head>
  <body>
    <h1>BLE Web Connection</h1>
    <button id="connectBtn">Connect to ESP32</button>
    <pre id="log"></pre>
    <script>
      const logElem = document.getElementById("log");
      function log(msg) {
        console.log(msg);
        logElem.textContent += msg + "\n";
      }

      const DEVICE_NAME = "NPG";
      const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
      const DATA_CHAR_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
      const CONTROL_CHAR_UUID = "0000ff01-0000-1000-8000-00805f9b34fb";

      const SINGLE_SAMPLE_LEN = 7;
      const BLOCK_COUNT = 10;
      const NEW_PACKET_LEN = SINGLE_SAMPLE_LEN * BLOCK_COUNT; // 70 bytes

      let prevSampleCounter = null;
      let samplesReceived = 0;

      function processSample(dataView) {
        if (dataView.byteLength !== SINGLE_SAMPLE_LEN) {
          log("Unexpected sample length: " + dataView.byteLength);
          return;
        }
        
        const sampleCounter = dataView.getUint8(0);
        if (prevSampleCounter === null) {
          prevSampleCounter = sampleCounter;
        } else {
          const expected = (prevSampleCounter + 1) % 256;
          if (sampleCounter !== expected) {
            log(`Missing sample: expected ${expected}, got ${sampleCounter}`);
          }
          prevSampleCounter = sampleCounter;
        }

        const ch0 = dataView.getInt16(1, false);
        const ch1 = dataView.getInt16(3, false);
        const ch2 = dataView.getInt16(5, false);
        log(`Sample ${sampleCounter}: Channels: ${ch0}, ${ch1}, ${ch2}`);
        samplesReceived++;
      }

      function handleNotification(event) {
        const value = event.target.value;
        if (value.byteLength === NEW_PACKET_LEN) {
          for (let i = 0; i < NEW_PACKET_LEN; i += SINGLE_SAMPLE_LEN) {
            const sampleBuffer = value.buffer.slice(i, i + SINGLE_SAMPLE_LEN);
            const sampleDataView = new DataView(sampleBuffer);
            processSample(sampleDataView);
          }
        } else if (value.byteLength === SINGLE_SAMPLE_LEN) {
          processSample(new DataView(value.buffer));
        } else {
          log("Unexpected packet length: " + value.byteLength);
        }
      }

      async function connectBLE() {
        try {
          if (!navigator.bluetooth) {
            log("Web Bluetooth API is not available in this browser.");
            return;
          }
          log("Requesting Bluetooth device...");
          const device = await navigator.bluetooth.requestDevice({
            filters: [{ name: DEVICE_NAME }],
            optionalServices: [SERVICE_UUID],
          });
          log("Connecting to GATT Server...");
          const server = await device.gatt.connect();
          log("Getting Service...");
          const service = await server.getPrimaryService(SERVICE_UUID);
          log("Getting Control Characteristic...");
          const controlChar = await service.getCharacteristic(CONTROL_CHAR_UUID);
          log("Getting Data Characteristic...");
          const dataChar = await service.getCharacteristic(DATA_CHAR_UUID);

          log("Sending START command...");
          const encoder = new TextEncoder();
          await controlChar.writeValue(encoder.encode("START"));

          log("Starting notifications...");
          await dataChar.startNotifications();
          dataChar.addEventListener("characteristicvaluechanged", handleNotification);
          log("Notifications started. Listening for data...");

          setInterval(() => {
            log("Samples per second: " + samplesReceived);
            samplesReceived = 0;
          }, 1000);
        } catch (error) {
          log("Error: " + error);
        }
      }

      document.getElementById("connectBtn").addEventListener("click", connectBLE);
    </script>
  </body>
</html>